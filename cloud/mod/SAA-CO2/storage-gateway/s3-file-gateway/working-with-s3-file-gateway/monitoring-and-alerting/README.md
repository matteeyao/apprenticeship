# Monitor and Alerting

Systematically monitoring AWS resources is the basis for determining the most valuable and efficient use of resources. Storage Gateway captures health and performance data and, in combination with AWS services, you can gain insight, automatically process, and react to specific metrics, thresholds, and events.

Storage Gateway integrates with services such as the following:

* **Amazon CloudWatch**, to monitor the health of your Storage Gateway and file shares

* **Amazon EventBridge**, to get notified when file operations are done

* **AWS CloudTrail**, to track user activity

Storage Gateway generates health and performance logs and metrics. Audit logs detail user access to files and folders within a file share. Metrics track the health of your gateway over a period, considering both gateway-specific and volume-specific metrics.

## CloudWatch

> Monitor a file gateway and file shares.

You can monitor your file gateway and associated resources in CloudWatch by using Storage Gateway health and performance logs and metrics.

The Storage Gateway console provides a consolidated view of CloudWatch metrics and any CloudWatch alarms you have configured. 

### Metrics

<table style="width:100%;"><thead><tr><th style="width:21.8381%;"><span style="font-size:17px;">Metric</span></th><th style="width:78.0306%;"><span style="font-size:17px;">Description</span></th></tr></thead><tbody><tr><td style="width:21.8381%;"><span style="font-size:17px;">AvailabilityNotifications&nbsp;</span></td><td style="width:78.0306%;"><span style="font-size:17px;">Number of availability-related health notifications generated by the gateway</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">CacheHitPercent</span></td><td style="width:78.0306%;"><span style="font-size:17px;">Percentage of application read operations from the file shares that are served from cache</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">CachePercentDirty</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The file share's contribution to the overall percentage of the gateway's cache that has not been persisted to AWS</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">CachePercentUsed</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The file share's contribution to the overall percentage use of the gateway's cache storage</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">CloudBytesUploaded</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The total number of bytes that the gateway uploaded to AWS during the reporting period</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">CloudBytesDownloaded&nbsp;</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The total number of bytes that the gateway downloaded from AWS during the reporting period</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">HealthNotifications</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The number of health notifications that were generated by this gateway in the reporting period</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">IoWaitPercent</span></td><td style="width:78.0306%;"><span style="font-size:17px;">Percentage of time that the gateway is waiting on a response from the local disk</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">ReadBytes&nbsp;</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The total number of bytes read from your on-premises applications in the reporting period for a file share</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">WriteBytes&nbsp;</span></td><td style="width:78.0306%;"><span style="font-size:17px;">The total number of bytes written from your on-premises applications in the reporting period</span></td></tr><tr><td style="width:21.8381%;"><span style="font-size:17px;">WriteTime</span><br></td><td style="width:78.0306%;"><span style="font-size:17px;">The total number of milliseconds spent on write operations from your on-premises application in the reporting period</span><br></td></tr></tbody></table>

The following are examples of using the metrics:

* Analyze the `CloudBytesDownloaded` and `CloudBytesUploaded` metrics to understand throughput between your S3 File Gateway and the AWS Cloud.

* Calculate the percentage of read requests that are served from the cache by using the `CacheHitPercent` metric with the Average statistic.

* Use the `WriteTime` metric with the Average statistic to measure latency.

* Monitor performance of your Storage Gateway by monitoring metrics such as `CachePercentDirty`. The higher the percentage of dirty cache (data that has not been written to Amazon S3), the lower the space available for low-latency data.

### Metrics and CloudWatch alarms

You can set alarms to notify you of changes in workloads. Alarms can be based on a single metric or a combination of metrics. You can add alarms to CloudWatch dashboards and monitor them visually. An alarm can invoke an action when it changes state, based on an evaluation period, repetitions, and data points to evaluate.

For each activated gateway, we recommend that you create the following CloudWatch alarms:

* High IO wait: `IoWaitpercent` >= 20 for 3 datapoints in 15 minutes

* Cache percent dirty: `CachePercentDirty` > 80 for 4 datapoints within 20 minutes

* Availability notifications: `AvailabilityNotifications` >= 1 for 1 datapoints within 5 minutes

* Health notifications: `HealthNotifications` >= 1 for 1 datapoints within 5 minutes

### Events as actions through EventBridge

Storage Gateway generates events that **EventBridge** uses. **EventBridge** receives the event and applies a rule to route the event to a target. Storage Gateway events indicate a change. Events received by **EventBridge** can be routed to additional targets such as **Amazon Simple Notification Service (Amazon SNS)** topics and **Amazon Simple Queue Service (Amazon SQS)**. They can also invoke an AWS Lambda function.

Some relevant Storage Gateway events include the following:

* Asynchronous uploading of your files from the file share to Amazon S3.

* Asynchronous uploading of your working file set from the file share to Amazon S3. 

* Refreshing the cache for your S3 bucket. 

Consider this example of the usefulness of **EventBridge**: You can set up a lifecycle policy to transition objects to **S3 Glacier Flexible Retrieval**. If, however, its file equivalent is in the cache of the S3 File Gateway appliance, an attempt to access or update the file through the file share will cause an I/O error. **EventBridge** can be set up to monitor these I/O error occurrences and take action, such as restoring the archived object to Amazon S3. This action will then allow the file share client to once again successfully interact with the object through the file share.

## CloudTrail 

Any actions taken by a user, role, or AWS service in Storage Gateway are logged as Storage Gateway application programming interface (API) calls in CloudTrail. 

CloudTrail reports on who performed the action, event name, timestamp, AWS Region, the IP address from which the request was made, and a list of API parameters showing the configuration of the file share, such as read-only, Amazon S3 storage class, requester pays, and so forth.

CloudTrail can send its logs to CloudWatch so that events created in CloudTrail can be monitored.
